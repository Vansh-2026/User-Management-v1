import e from"jsonwebtoken";import t,{promises as n,accessSync as o,constants as r,readFileSync as s,existsSync as i,writeFileSync as a}from"fs";import*as c from"path";import{resolve as u,join as l,dirname as d,sep as p}from"path";import h from"os";import{exec as f,spawn as m}from"child_process";import w from"readline";import g,{randomBytes as y}from"crypto";import E,{promisify as I}from"util";import{globSync as T}from"glob";import{request as C}from"https";import{request as U,createServer as v}from"http";import{URL as L}from"url";function k(t,n){return new Promise((o,r)=>{e.verify(t,n,{algorithms:["RS256"]},function(e,t){e&&r(e),o(t)})})}async function N(e,t){const n=await k(e,t);return n.licenses?.length>0&&await Promise.all(n.licenses.map(e=>k(e,t))),n}const R="https://licensing.telerik.com",b=R+"/api/v1/key",A=R+"/api/v1/usage",O="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2mnUVMmkth2x+N/ODszG\nOFIYBL6NOO1XWRj1wkmecKuLziJDhFz0WQmyOjY34Ymg9pLuBA9QSWrrZuvPw40N\nm0X/GBmttFmPNvca3WmJ2oKM7PpLiUU9f7Ov5WeIXnx++ts/LC/OB7FtZ+LiRgJ7\n0mZnPeTogdFrASf0zSQJv4jmX840LPa6nomWeUgIVGPLLVI14Gib8Dl+nOckqCNc\nkAUUk4IBF67DufRt9zQyRxg99ysakvHX2SDbdGvIBdxWxvhhmrBoeix0uSVtG2gm\njdvSqlPJVdvMbk1Xe2+SUldJPrxH1VrTYeRUt4yqWxy16nFJUDj9exZ202X4THkU\nJQIDAQAB\n-----END PUBLIC KEY-----",P=Object.freeze({CLIENT_ID:"kendo.licensing.cli.v1",CLIENT_SECRET:"349c875fc2d084006df60ae4b7b63c0d",AUTHORIZATION_URL:"https://identity.telerik.com/login",TOKEN_URL:"https://identity.telerik.com/v2/oauth/telerik/token",CALLBACK_PATH:"/callback"}),$=["TELERIK_LICENSE","KENDO_UI_LICENSE"],S="telerik-license.txt",D=[S,"kendo-ui-license.txt"],_="TELERIK_LICENSING_APIENDPOINTADDRESS",x="localhost",K="/callback",B=3e5,M="https://prgress.co/3PxpDaP",V=["KENDOUIANGULAR","KENDOUICOMPLETE","KENDOUIREACT","KENDOUIVUE"],W=["TF_BUILD","GITHUB_ACTIONS","GITLAB_CI","bamboo.buildKey","BUILDKITE","CIRCLECI","CIRRUS_CI","CODEBUILD_BUILD_ID","HEROKU_TEST_RUN_ID","TEAMCITY_VERSION","TRAVIS","BUILDER_OUTPUT","GERRIT_PROJECT","SYSTEM_TEAMFOUNDATIONCOLLECTIONURI","BITRISE_IO","BUDDY_WORKSPACE_ID","APPVEYOR","CIRCLECI","SEMAPHORE","DRONE","DSARI","TDDIUM","SCREWDRIVER","STRIDER","TASKCLUSTER_ROOT_URL","JENKINS_URL","GO_PIPELINE_NAME","HUDSON_URL","WERCKER","NETLIFY","NOW_GITHUB_DEPLOYMENT","GITLAB_DEPLOYMENT","BITBUCKET_DEPLOYMENT","BITBUCKET_BUILD_NUMBER","NOW_BUILDER","VERCEL_GITLAB_DEPLOYMENT","VERCEL_BITBUCKET_DEPLOYMENT","VERCEL_URL","MAGNUM","NEVERCODE","RENDER","SAIL_CI","SHIPPABLE","TEAMCITY_VERSION","BUILD_ID","CI_NAME","CI"];var F;!function(e){e.BLAZOR="BLAZOR",e.DPL="DPL",e.JM="JM",e.KENDOUIANGULAR="KENDOUIANGULAR",e.KENDOUICOMPLETE="KENDOUICOMPLETE",e.KENDOUIMVC="KENDOUIMVC",e.KENDOUIREACT="KENDOUIREACT",e.KENDOUIVUE="KENDOUIVUE",e.MAUI="MAUI",e.RCAJAX="RCAJAX",e.RCWF="RCWF",e.RCWPF="RCWPF",e.REPORTING="REPORTING",e.REPORTSERVER="REPORTSERVER",e.UIASPCORE="UIASPCORE",e.UIXAM="UIXAM",e.WINUI="WINUI"}(F||(F={}));const j=Object.freeze({[F.BLAZOR]:"Telerik UI for Blazor",[F.DPL]:"Telerik Document Processing",[F.JM]:"Telerik JustMock",[F.KENDOUIANGULAR]:"Kendo UI for Angular",[F.KENDOUICOMPLETE]:"Kendo UI for jQuery",[F.KENDOUIMVC]:"Telerik UI for ASP.NET MVC",[F.KENDOUIREACT]:"KendoReact",[F.KENDOUIVUE]:"Kendo UI for Vue",[F.MAUI]:"Telerik UI for .NET MAUI",[F.RCAJAX]:"Telerik UI for ASP.NET AJAX",[F.RCWF]:"Telerik UI for WinForms",[F.RCWPF]:"Telerik UI for WPF",[F.REPORTING]:"Telerik Reporting",[F.REPORTSERVER]:"Telerik Report Server",[F.UIASPCORE]:"Telerik UI for ASP.NET Core",[F.UIXAM]:"Telerik UI for Xamarin",[F.WINUI]:"Telerik UI for WinUI"}),z=Object.freeze({perpetual:"Perpetual license",subscription:"Subscription license",trial:"Trial license"});function H(){const e=process.env.INIT_CWD||process.cwd();return u(e)}class G extends Error{constructor(e,t,n){super(e),this.name=this.constructor.name,this.exitCode=t,this.suggestion=n,"captureStackTrace"in Error&&Error.captureStackTrace(this,this.constructor)}}class J extends G{constructor(e,t){super(e,4,t||"Please check your credentials and try again.")}}class Y extends G{constructor(e,t){super(e,5,t||"Check your internet connection and try again.")}}class q extends G{constructor(e,t){super(e,4,t||"Try again to complete authentication.")}}class X extends G{constructor(e,t){super(e,3,t||"Check file permissions and disk space.")}}function Q(){const e=h.homedir();if("win32"===h.platform()){const t=process.env.APPDATA||l(e,"AppData","Roaming");return l(t,"Telerik")}return l(e,".telerik")}async function Z(e){try{await n.mkdir(e,{recursive:!0})}catch(t){throw new X(`Failed to create directory ${e}: ${t.message}`)}}async function ee(e,t){const o=d(e);try{await Z(o);if(!await async function(e){try{return await n.access(e,n.constants.W_OK),!0}catch{return!1}}(o))throw new X(`Permission denied writing to ${e}`);await n.writeFile(e,t,"utf8")}catch(t){if(t instanceof X)throw t;throw"EACCES"===t.code?new X(`Permission denied writing to ${e}`):"ENOSPC"===t.code?new X("Insufficient disk space to write license file"):"ENOENT"===t.code?new X(`Directory does not exist: ${o}`):new X(`Failed to write file ${e}: ${t.message}`)}}async function te(e){if(!await async function(e){try{return await n.access(e),!0}catch{return!1}}(e))return null;const t=`${e}.bak`;try{const o=await async function(e){try{return await n.readFile(e,"utf8")}catch(t){throw"ENOENT"===t.code?new X(`File not found: ${e}`):"EACCES"===t.code?new X(`Permission denied reading file: ${e}`):new X(`Failed to read file ${e}: ${t.message}`)}}(e);return await ee(t,o),t}catch(t){throw new X(`Failed to create backup of ${e}: ${t.message}`)}}async function ne(e){try{const t=await n.stat(e);return{size:t.size,isDirectory:t.isDirectory()}}catch(e){return{size:0,isDirectory:!1}}}function oe(){const e=H().split(p),t=[],n=process.env.TELERIK_LICENSE_PATH;if(n&&n.length>0)return[n];for(let n=0;n<e.length;n++){const o=e.slice(0,e.length-n).join(p);t.push(o||p)}return t.push(Q()),t.flatMap(e=>D.map(t=>l(e,t)))}function re(){const e=function(){for(const e of oe())try{return o(e,r.R_OK),e}catch(e){}return null}();if(null!==e){return{success:!0,source:e,value:s(e,{encoding:"utf-8"}).trim()}}return{success:!1,message:oe().map(e=>`* ${e}`).join("\n")}}function se(){const e=function(){for(const e of $){const t=process.env[e];if(t&&t.length>0)return{success:!0,source:e,value:t.trim()}}return{success:!1,message:`* Environment Variables: ${$.join(", ")}\n`}}();if(!0===e.success)return e;const t=re();return!0===t.success?t:{success:!1,message:"No Telerik and Kendo UI License file found.\n\nThe following locations were searched:\n"+e.message+t.message+"\n\nTo download a license key file, visit https://prgress.co/3PBSVoC"}}const ie=e=>Boolean(e)&&!["0","false","no"].includes(e.trim().toLowerCase()),ae=(e,t,n)=>`${((e,t)=>`[${e}][Telerik and Kendo UI Licensing]`+(t?` ${t}:`:""))(e,n)} ${t}`,ce=(e,t)=>console.warn(ae("WARN",e,t)),ue=e=>console.log(ae("INFO",e)),le=(e,t)=>{ie(process.env.TELERIK_LICENSING_DEBUG)&&console.log(ae("DEBUG",e,t))};function de(e){return Math.floor(e.getTime()/1e3)}function pe(){return de(new Date)}function he(e){const t=pe()-de(e);return Math.floor(t/86400)}function fe(e){const t=function(e){if("function"==typeof atob)return atob(e);if("function"==typeof Buffer)return Buffer.from(e,"base64").toString("utf8");throw new Error("atob is undefined")}(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}function me(e){const t=e.split(".")[1],n=String.fromCharCode(...(o=t,fe(o.replace(/-/g,"+").replace(/_/g,"/"))));var o;return JSON.parse(n)}function we(e){return new Date(1e3*e)}function ge(e,t){const n=we(t);return e>new Date(n.getFullYear(),n.getMonth(),n.getDate()+1).getTime()/1e3}function ye(e,t){const n=t.filter(e=>"usage"!==e.type).filter(t=>e.productCode===t.code||e.redistributedBy?.includes(t.code)||e.productCodes?.includes(t.code)).sort((e,t)=>t.expiration-e.expiration);return n.find(e=>"subscription"===e.type&&!ge(pe(),e.expiration))||n.find(t=>"perpetual"===t.type&&!ge(e.publishDate,t.expiration))||n.find(e=>"subscription"===e.type&&!ge(function(e,t){const n=new Date(1e3*e);return n.setDate(n.getDate()+t),de(n)}(pe(),10),e.expiration))||n.find(e=>"trial"===e.type&&!ge(pe(),e.expiration))||n.find(e=>"subscription"===e.type)||n.find(e=>"perpetual"===e.type)||n.find(e=>"trial"===e.type)}const Ee=e=>e.productCode||e.productCodes[0],Ie=E.promisify(f),Te=t.promises.readFile;function Ce(e){const t=Buffer.alloc(16);for(let n=0;n<16;n++)t[n]=e[n]^e[n+16];function n(e,n){let o="";for(let r=e;r<=n;r++)o+=t[r].toString(16).padStart(2,"0");return o}return`${n(0,3)}-${n(4,5)}-${n(6,7)}-${n(8,9)}-${n(10,15)}`}async function Ue(){try{switch(process.platform){case"win32":return await async function(){const e=m("powershell.exe",["-nologo","-Command","$BIOS = @(Get-WmiObject Win32_BIOS | Select-Object -Property Manufacturer, SerialNumber, Name);$Product = @(Get-WmiObject Win32_ComputerSystemProduct | Select-Object -Property UUID);New-Object -TypeName PSObject -Property @{    'BIOS' = $BIOS;    'Product' = $Product;} | ConvertTo-JSON"]);let t="";const n=w.createInterface(e.stdout);for await(const e of n)t=""==t?e:t+"\n"+e;const o=JSON.parse(t);let r="Telerik Licensing\nWorkstation Id Fingerprint\n";function s(e){null!=e&&""!=e&&(r+=e+";")}r+="BIOS:\n";for(const e of o.BIOS)r+="  - ",s(e.Manufacturer),s(e.SerialNumber),s(e.Name),r+="\n";r+="Product:\n";for(const e of o.Product)r+="  - ",s(e.UUID),r+="\n";const i=g.createHash("sha256");i.update(r);const a=Ce(i.digest());return{fingerprint:r,id:a}}();case"darwin":return await async function(){const e=(await Ie("ioreg -rd1 -w0 -c IOPlatformExpertDevice"))?.stdout?.toString(),{platformUUID:t}=e.match(/"IOPlatformUUID"\s=\s"(?<platformUUID>[0-9A-F-]*)"/).groups,{platformSN:n}=e.match(/"IOPlatformSerialNumber"\s=\s"(?<platformSN>[^"]*)"/).groups,o=(await Ie("sysctl hw.model"))?.stdout?.toString(),{hardwareModel:r}=o.match(/^hw.model:\s(?<hardwareModel>.*)$/m).groups,s=`Telerik Licensing\nWorkstation Id Fingerprint\nPlatform UUID: ${t}\nPlatform S/N: ${n}\nHardware model: ${r}\n`,i=g.createHash("sha256");return i.update(s),{fingerprint:s,id:Ce(i.digest())}}();case"linux":return await async function(){let e="";try{e=(await Te("/etc/machine-id"))?.toString()?.trim()||""}catch{}try{e=e||(await Te("/var/lib/dbus/machine-id"))?.toString()?.trim()||""}catch{}let t="";try{t=(await Te("/sys/devices/virtual/dmi/id/bios_vendor"))?.toString()?.trim()||""}catch{}let n="";try{n=(await Te("/sys/devices/virtual/dmi/id/board_vendor"))?.toString()?.trim()||""}catch{}let o="";try{o=(await Te("/sys/devices/virtual/dmi/id/chassis_vendor"))?.toString()?.trim()||""}catch{}const r=`Telerik Licensing\nWorkstation Id Fingerprint\nMachine Id: ${e}\nBIOS Vendor: ${t}\nBoard Vendor: ${n}\nChassis Vendor: ${o}\n`,s=g.createHash("sha256");return s.update(r),{fingerprint:r,id:Ce(s.digest())}}();default:throw new Error(`Platform ${process.platform} not supported.`)}}catch(e){return{fingerprint:"<error>",id:"00000000-0000-0000-0000-000000000000"}}}let ve;function Le(){return ve||(ve=Ue())}function ke(e){const t=process.env[e];return t&&"false"!==t.toLowerCase()}function Ne(){if(ke("TF_BUILD"))return"Azure Pipelines";if(ke("GITHUB_ACTIONS"))return"GitHub Actions";for(const e of W)if(ke(e))return"Other"}async function Re(e,t){const n=new AbortController,o=setTimeout(()=>n.abort(),t.timeout);try{const r=await fetch(e,{method:t.method,headers:t.headers,body:t.body,signal:n.signal});clearTimeout(o);const s=await r.text(),i={};return r.headers.forEach((e,t)=>{i[t]=e}),{status:r.status,statusText:r.statusText,headers:i,body:s}}catch(e){if(clearTimeout(o),"AbortError"===e.name)throw new Error(`Request timed out after ${t.timeout}ms`);throw e}}const be={method:"GET",headers:{},timeout:3e4,retries:3,retryDelay:1e3};async function Ae(e,t={}){const n={...be,...t};let o;for(let t=0;t<n.retries;t++)try{return await Re(e,n)}catch(r){o=r;const s=n.retryDelay*Math.pow(2,t);ce(`Network error during ${n.method?.toUpperCase()} ${e}`),ue(`Retrying in ${s/1e3} seconds (attempt ${t+1}/${n.retries})...`),await Oe(s)}const r=o?o.message:"Unknown error";throw new Y(`Failed to ${n.method?.toLowerCase()} ${e}: ${r}`)}function Oe(e){return new Promise(t=>setTimeout(t,e))}async function Pe(e){const{accessToken:t,outputPath:n}=e;if(!t)throw new G("Access token is required",4,"Complete OAuth authentication first");try{ue("Downloading license key...");const e=await async function(e){const t=b;le(`Fetching license from ${t}`);const n=await async function(e,t={}){return Ae(e,{...t,method:"GET"})}(t,{headers:{Authorization:`Bearer ${e}`,Accept:"text/plain"},timeout:3e4});if("string"==typeof n.body&&200===n.status)return n.body;const o=n.status;if(401===o)throw new G("Authentication failed - access token is invalid or expired",4,"Please re-authenticate with the refresh command");if(403===o)throw new G("Access forbidden - insufficient token permissions",4,"The license client may be outdated. Please update and try again.");if(429===o)throw new Y("Rate limit exceeded","Wait a few minutes before trying again");if(o>=500)throw new Y(`License server error (${o})`,"Try again later or contact support if the problem persists");throw new Y(`Unable to fetch key from license API. Server responded with ${o}`,"Please try again later")}(t),o=await async function(e){if(!e){const e=Q();return c.join(e,S)}const t=await ne(e);if(t.isDirectory||e.endsWith("/")||e.endsWith(c.sep))return c.join(e,S);return e}(n),r={content:e,filename:c.basename(o),filepath:o,size:Buffer.byteLength(e,"utf8"),downloadedAt:new Date};await async function(e){if(!e.content||0===e.content.trim().length)throw new Error("License content cannot be empty");if(!e.filepath||0===e.filepath.trim().length)throw new Error("License file path cannot be empty");const t=await N(e.content,O).catch(()=>null);if(null==t)throw le("License key content does not appear to be valid: "+e.content),new Error("License key content is not valid")}(r),le(`Saving license to: ${o}`),await async function(e,t){try{const n=c.dirname(t);await Z(n),await te(t),await ee(t,e.content),le(`License file written: ${t}`)}catch(e){throw new X(`Failed to save license to ${t}: ${e.message}`,"Check file permissions and disk space")}}(r,o);return{licenseKey:r,filePath:o,fileSize:(await ne(o)).size,downloadedAt:r.downloadedAt}}catch(e){if(e instanceof G)throw e;throw new G(`Failed to download license: ${e.message}`,5,"Check your internet connection and try again")}}function $e(e){try{const t=s(e,{encoding:"utf-8"});return JSON.parse(t)}catch(e){return{}}}const Se=/@(progress|telerik)\/[^/@"]+/,De=e=>e.match(Se)?.[0],_e=e=>Se.test(e);function xe(e){const t=function(e){const t=$e(l(e,"package-lock.json")).packages||{},n=new Map;for(const e of Object.keys(t)){const o=t[e],r=De(e);r&&Boolean(o.version)&&n.set(r,o.version)}return n}(e),n=function(e){let t="";try{t=s(l(e,"yarn.lock"),{encoding:"utf-8"})}catch(e){}const n=new Map,o=t.split("\n");return o.forEach((e,t)=>{const r=e.startsWith('"@progress/')||e.startsWith('"@telerik/'),s=De(e);if(r&&s&&t<o.length-1){const e=o[t+1],r=e.match(/version[\s:]+"?([.\d]+)"?/)?.[1];r&&n.set(s,r)}}),n}(e),o=function(...e){const t=new Map;for(const n of e)for(const[e,o]of n.entries())t.set(e,o);return t}(t,n),r=$e(l(e,"package.json")),i={...r.dependencies,...r.devDependencies};for(const e of Object.keys(i)){const t=i[e];_e(e)&&Boolean(t)&&o.set(e,t)}return o}const Ke=[{match:e=>"@progress/kendo-ui"===e,code:F.KENDOUICOMPLETE,name:j.KENDOUICOMPLETE},{match:e=>e.startsWith("@progress/kendo-angular-"),code:F.KENDOUIANGULAR,name:j.KENDOUIANGULAR},{match:e=>e.startsWith("@progress/kendo-react-"),code:F.KENDOUIREACT,name:j.KENDOUIREACT},{match:e=>e.startsWith("@progress/kendo-vue-"),code:F.KENDOUIVUE,name:j.KENDOUIVUE}],Be=e=>e.replace(/^[~^v><= ]+/g,"");function Me(e){let t;const n=H();try{t=require.resolve(e+"/package.json",{paths:[n]})}catch(o){const[r,s]=e.split("/");t=l(n,"node_modules",r,s,"package.json")}return t}function Ve(e){return Boolean(e&&(e.productCode||e.productCodes?.length>0))}async function We(e){const t=xe(e).keys(),n=[];for(const e of t){const t=Me(e),o=d(t),r=$e(t);let s=r["@progress"]?.package;if(Ve(s))s.name=r.name,s.version=r.version,n.push(s);else{const e=[l(o,"esm2022","package-metadata.mjs"),l(o,"package-metadata.mjs")];let t;for(;!t&&e.length>0;)t=await import(e.shift()).catch(()=>{});if(t&&t.packageMetadata&&Ve(t.packageMetadata)){s=t.packageMetadata;const e=s.version||r.version;n.push({...s,version:e})}}}return n}function Fe(e){const t=new Map;for(const n of e){const e=Ee(n);let o;t.has(e)?o=t.get(e):(o=new Map,t.set(e,o)),o.has(n.version)||o.set(n.version,{...n,name:"<group>"})}return[...t.values()].flatMap(e=>[...e.values()])}function je(e,t){const n=`${e}: `,o=we(t.expiration),r=-he(o);"subscription"===t.type?ue(n+`Your ${e} subscription is active. `+`Expiration in ${r} days - ${o.toLocaleDateString()}.`):"trial"===t.type?ue(n+`Your ${e} trial expires in ${r} days.`):"perpetual"===t.type&&ue(n+"Valid license found.")}class ze{constructor(e,t){this.productName=e,this.severity="WARN",this.code="TKL101",this.licenseEvidence=null,this.message=`${e} is not listed in your current license file.\n  Learn more about ${e} licensing at ${t}`}}class He{constructor(e,t,n,o,r){this.productName=e,this.licenseEvidence=t,this.severity="WARN",this.code="TKL102",this.message=`Your current license has expired on ${n.toLocaleDateString()} and is not valid for ${e} version ${o}. The product was published on ${r.toLocaleDateString()}.\n  Renew your license at https://prgress.co/3PwQNi1`}}class Ge{constructor(e,t,n){this.productName=e,this.licenseEvidence=t,this.severity="WARN",this.code="TKL103",this.message=`Your subscription has expired ${n} days ago.\n  Renew your maintenance and support to enjoy uninterrupted service at https://prgress.co/3PwQMut`}}class Je{constructor(e,t,n){this.productName=e,this.licenseEvidence=t,this.severity="WARN",this.code="TKL104",this.message=`Your subscription has expired ${n} days ago.\n  Renew your maintenance and support to enjoy uninterrupted service at https://prgress.co/3PwQMut`}}class Ye{constructor(e,t,n){this.productName=e,this.licenseEvidence=t,this.severity="WARN",this.code="TKL105",this.message=`Your trial has expired ${n} days ago.\n  Thank you for trying out ${e}, we hope you enjoyed your trial period.\n  To continue using our product, consider upgrading to a commercial license: https://prgress.co/3PwQMdX`}}const qe=e=>{let t=(e.licenses||[]).map(e=>me(e));return 0===t.length&&e.products&&(t=(e.products||[]).map(t=>({type:t.trial?"trial":"perpetual",code:t.code,expiration:t.licenseExpirationDate,licenseId:e.licenseId,userId:e.userId}))),t};function Xe(e,t){const n=e.licenses||[],o=qe(e),r=o.findIndex(e=>"usage"===e.type),s=-1!==r?n[r]:null,i=Fe(t),a=new Map,c=new Map,u=new Map;for(const e of i){const t=e.productCode||e.productCodes[0],n=ye(e,o);if(n)if("subscription"===n.type&&ge(pe(),n.expiration)){const o=he(we(n.expiration));o>10?c.set(t,new Ge(e.productName,n,o)):c.set(t,new Je(e.productName,n,o))}else if("perpetual"===n.type&&ge(e.publishDate,n.expiration))c.set(t,new He(e.productName,n,we(n.expiration),e.version,we(e.publishDate)));else if("trial"===n.type&&ge(pe(),n.expiration)){const o=he(we(n.expiration));c.set(t,new Ye(e.productName,n,o))}else a.has(n.code)||(a.set(n.code,n),u.set(n.code,e.productName));else c.set(t,new ze(e.productName,e.licensingDocsUrl))}return{productErrors:c,productLicenses:a,productVersions:i,productNames:u,usageEvidence:s}}function Qe(e,t){const n=H(),o=[l(l(__dirname,"../dist"),"index*.{js,mjs}"),l(n,".angular/cache/**/vite/deps*/chunk-*.js"),l(n,".angular/cache/**/vite/deps*/@progress*.js"),l(n,".next/static/chunks/*.js"),l(n,"node_modules/.vite/deps/chunk-*.js"),l(n,"node_modules/.vite/deps/@progress*.js")].map(e=>e.replace(/\\/g,"/")),r=function(e,t){const n=(e.licenses||[]).filter(e=>{const n=me(e);return"usage"!==n.type&&t.includes(n.code)});return{products:n.length>0?[]:e.products||[],licenses:n,userId:e.userId,integrity:e.integrity,scriptKey:!1,timestamp:e.iat}}(e,t),i=JSON.stringify(JSON.stringify(r)),c=`  ${i.substring(1,i.length-1)}  `;le(JSON.stringify(r)),T(o,{nodir:!0}).forEach(e=>{const t=s(e,{encoding:"utf-8"}).replace(/ {2}{.*} {2}/,c);a(e,t,{encoding:"utf-8"})})}const Ze=I(f);function et(){const e=process.platform;return"win32"===e?"win32":"darwin"===e?"darwin":"linux"===e?"linux":"unknown"}async function tt(e){const{url:t}=e;if(!t||!function(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch{return!1}}(t))throw new G(`Invalid URL: ${t}`,3,"Provide a valid HTTP or HTTPS URL");try{le(`Opening URL in browser: ${t}`);const e=function(e){const t=et();switch(t){case"win32":return`start "" "${e}"`;case"darwin":return`open "${e}"`;case"linux":return`xdg-open "${e}" || gnome-open "${e}" || kde-open "${e}"`;default:throw new G(`Unsupported platform: ${t}`,3,"Please open the URL manually in your browser")}}(t);return le(`Executing command: ${e}`),await Ze(e),le("Browser opened successfully"),!0}catch(e){return le(`Failed to open browser: ${e.message}`),!1}}function nt(e){const t="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━";console.log("\n"+t),console.log("  Please open this URL in your browser:"),console.log(t+"\n"),console.log(`  ${e}\n`),console.log(t),console.log(`  ${function(){switch(et()){case"win32":case"linux":return"Copy the URL and paste it into your browser's address bar";case"darwin":return"Copy the URL (Cmd+C) and paste it into your browser's address bar";default:return"Open the URL in your web browser"}}()}`),console.log(t+"\n")}const ot=()=>ie(process.env.TELERIK_TELEMETRY_INTERNAL);async function rt({url:e,payload:t,timeout:n}){const o=e.port?Number.parseInt(e.port,10):void 0,r={protocol:e.protocol,hostname:e.hostname,port:o,path:e.pathname,timeout:n,method:"POST",headers:{"Content-Type":"application/json"}};return new Promise((e,n)=>{const o=(e=>"https:"===e.protocol?C(e):U(e))(r);o.on("error",e=>{n(e)}),o.on("timeout",()=>{n(new Error("Request timeout"))}),o.on("close",()=>{e()}),o.end(JSON.stringify(t))})}async function st(e){return rt({url:new URL(process.env[_]||A),payload:e,timeout:3e3})}async function it(e,t,n){const{id:o}=await Le(),r=we(e.expiration).toISOString().split(".")[0]+"Z",s=function(e){if(void 0!==e)return null===e?null:{Type:e.type,CI:e.CI,UserId:e.userId,LicenseId:e.licenseId,WorkstationId:e.workstationId,ProductCode:e.productCode,ProductLicenseType:e.productLicenseType,ProductLicenseValidity:e.productLicenseValidity,ProductVersion:e.productVersion,UsageEvidence:e.usageEvidence,IsInternalUsage:e.isInternalUsage}}({type:"LicenseUsed",userId:e.userId,licenseId:e.licenseId,workstationId:o,productCode:e.code,productLicenseType:e.type,productLicenseValidity:r,productVersion:n,usageEvidence:t,isInternalUsage:!!ot()||void 0,CI:Ne()});le("LicenseUsed: "+JSON.stringify(s,null,2)),await st(s).catch(e=>{le(`Failed to send telemetry: ${e}`)})}async function at({licenseKey:e,licenseEvidence:t,licenseErrorCode:n,usageEvidence:o,productVersion:r,productCode:s}){const{id:i}=await Le(),a=t?we(t.expiration).toISOString().split(".")[0]+"Z":void 0,c=function(e){if(void 0!==e)return null===e?null:{Type:e.type,ProductCode:e.productCode,ProductVersion:e.productVersion,LicenseErrorCode:e.licenseErrorCode,ProductLicenseType:e.productLicenseType,ProductLicenseValidity:e.productLicenseValidity,LicenseId:e.licenseId,UserId:e.userId,WorkstationId:e.workstationId,CI:e.CI,IsInternalUsage:e.isInternalUsage,UsageEvidence:e.usageEvidence}}({type:"LicenseNotValid",productCode:s,productVersion:r,licenseErrorCode:n,productLicenseType:t?.type,productLicenseValidity:a,licenseId:e.licenseId,userId:e.userId,workstationId:i,CI:Ne(),isInternalUsage:!!ot()||void 0,usageEvidence:o});le(`Workstation ID: ${i}`),le("LicenseNotValid: "+JSON.stringify(c,null,2)),await st(c).catch(e=>{le(`Failed to send LicenseNotValid telemetry: ${e}`)})}const ct=()=>(process.env[_]||A).replace("/usage","/collect");async function ut({productVersion:e,productCode:t}){const{id:n}=await Le(),o=function(e){if(void 0!==e)return null===e?null:{Type:e.type,ProductCode:e.productCode,ProductVersion:e.productVersion,WorkstationId:e.workstationId,CI:e.CI,IsInternalUsage:e.isInternalUsage}}({type:"LicenseNotFound",productCode:t,productVersion:e,workstationId:n,CI:Ne(),isInternalUsage:!!ot()||void 0});le("LicenseNotFound: "+JSON.stringify(o,null,2)),await async function(e){return rt({url:new URL(ct()),payload:e,timeout:3e3})}(o).catch(e=>{le(`Failed to send telemetry: ${e}`)})}const lt={command:"activate",describe:`Validates and imports a Telerik and Kendo UI license key file.\n\nThe following locations are searched for a license key:\n* The path specified in the \${LICENSE_ENV_PATH_VAR} environment variable.\n* The ${$.join(", ")} environment variables.\n* The ${D.join(", ")} files in:\n    * The current working directory\n    * Each parent directory\n    * ~/\${TELERIK_HOME_DIR} (Linux and macOS) or %APPDATA%\\\${TELERIK_HOME_DIR_WIN32} (Windows)`,builder:function(e){return e.option("ignore-no-license",{type:"boolean",description:"Sets the exit status to 0 (success) if a license file is missing.",default:!1})},handler:async function(e){const t=e.ignoreNoLicense,n=H(),{id:o}=await Le();le(`Workstation ID: ${o}`);let r=await We(n);0===r.length&&(r=function(e){const t=xe(e),n=[];for(const[e,o]of t){const t=Ke.find(t=>t.match(e));t&&n.push({name:e,productName:t.name,productCode:t.code,version:Be(o),publishDate:-1,licensingDocsUrl:""})}return n}(n));let s=function(e){const t=new Set(e.flatMap(e=>[e.productCode,...e.productCodes||[],...e.redistributedBy||[]]).filter(Boolean));return Array.from(t.values())}(r);0===s.length&&(ce("No Telerik or Kendo UI product references detected in project.\n  Consult the product documentation or contact support at https://prgress.co/3Pzpwvf"),s=V);const a=se();if(!1===a.success){try{await async function(e){const t=Fe(e);for(const e of t)await ut({productVersion:e.version,productCode:e.productCode})}(r)}catch(e){le(`Failed to send telemetry: ${e.message}`)}const e="TKL002: "+a.message;if(t)return void ue(e);throw new G(e,1)}let c;try{c=await N(a.value,O);const e=we(c.iat).toLocaleString();ue(`Telerik and Kendo UI License Key found at: ${a.source}\n  License issued at ${e} to ${c.aud}`)}catch(e){const t=`Corrupted Telerik and Kendo UI License Key content in ${a.source}\n  Download a new copy of the license key from ${M}`;throw new G(t,2)}if(r.length>0){const e=Xe(c,r);for(const t of e.productLicenses.values())le(`Resolved license for ${t.code}, ${t.type}, expires ${we(t.expiration).toISOString()}`);for(const t of e.productErrors.values())ce(t.message,t.code);try{await async function(e,t){if(e.usageEvidence){for(const t of e.productLicenses.values()){for(const n of e.productVersions)Ee(n)===t.code&&await it(t,e.usageEvidence,n.version);je(e.productNames.get(t.code),t)}for(const n of e.productErrors.values())for(const o of e.productVersions)o.productName===n.productName&&await at({licenseKey:t,licenseEvidence:n.licenseEvidence,licenseErrorCode:n.code,usageEvidence:e.usageEvidence,productVersion:o.version,productCode:o.productCode})}}(e,c)}catch(e){le(`Failed to send telemetry: ${e.message}`)}}try{Qe(c,s),function(){const e=H(),t=u(e,".next/cache");i(t)&&ce(`Next.js cache detected in ${t}\n  Delete the cache directory to apply the license key in production builds.`)}()}catch(e){throw console.error(e),new G("Error while importing license.",3)}}},dt={command:"help",describe:"Prints this help message.",handler:()=>{}};function pt(e,t="localhost"){return new Promise(n=>{const o=v();o.listen(e,t,()=>{o.close(()=>n(!0))}),o.on("error",()=>{n(!1)})})}class ht{constructor(e){const{preferredPort:t,host:n=x,callbackPath:o=K,timeout:r=B}=e;this.state={port:t,host:n,timeout:r,isListening:!1,callbackPath:o,startedAt:new Date,requestsReceived:0},this.httpServer=v((e,t)=>{this.handleRequest(e,t)}),this.validate()}validate(){if(this.state.port<=0||this.state.port>65535)throw new Error(`Invalid port number: ${this.state.port}`);if("localhost"!==this.state.host&&!ft(this.state.host))throw new Error("Host must be localhost to disable connections from external hosts");if(!this.state.callbackPath.startsWith("/"))throw new Error("Callback path must start with /")}tryStartOnPort(e){return new Promise((t,n)=>{this.httpServer?(this.httpServer.listen(e,this.state.host,()=>{t()}),this.httpServer.on("error",e=>{n(e)})):n(new Error("HTTP server not initialized"))})}setupTimeout(){this.timeoutId=setTimeout(()=>{if(this.callbackPromise){const e=(this.state.timeout||0)/1e3;this.callbackPromise.reject(new q(`OAuth flow timed out after ${e} seconds`,"Please re-run the command and authenticate in the browser"))}this.stop()},this.state.timeout)}handleRequest(e,t){this.state.requestsReceived++,this.state.lastActivity=new Date;if(!ft(e.socket.remoteAddress))return t.statusCode=403,t.setHeader("Content-Type","text/plain"),void t.end("Forbidden: External connections not allowed");if("GET"!==e.method)return t.statusCode=405,t.setHeader("Content-Type","text/plain"),void t.end("Method Not Allowed");if(parseInt(e.headers["content-length"]||"0",10)>0)return t.statusCode=413,t.setHeader("Content-Type","text/plain"),void t.end("Payload Too Large");const n=new L(e.url||"/",`http://${this.state.host}:${this.state.port}`);n.pathname===this.state.callbackPath?(this.handleCallback(n,t),this.stop()):(t.statusCode=404,t.setHeader("Content-Type","text/plain"),t.end("Not Found"))}handleCallback(e,t){const n={code:e.searchParams.get("code")||void 0,state:e.searchParams.get("state")||void 0,error:e.searchParams.get("error")||void 0,error_description:e.searchParams.get("error_description")||void 0};n.error?this.errorResponse(t,n):this.successResponse(t),this.callbackPromise&&(this.callbackPromise.resolve(n),this.callbackPromise=void 0)}errorResponse(e,t){e.statusCode=400,e.setHeader("Content-Type","text/html"),e.end((e=>`\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="utf-8">\n    <title>Login Error</title>\n    <style>body{ font-family:system-ui,sans-serif; padding:2rem; }</style>\n</head>\n<body>\n    <h1>Telerik Licensing - Login Error ❌</h1>\n    <p>${e.error}</p>\n    <p>${e.error_description||"No description provided"}</p>\n    <p>You can close this window and return to the terminal.</p>\n</body>\n</html>\n`)(t))}successResponse(e){e.statusCode=200,e.setHeader("Content-Type","text/html"),e.end('\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="utf-8">\n    <title>Login Successful</title>\n    <style>body{ font-family:system-ui,sans-serif; padding:2rem; }</style>\n</head>\n<body>\n    <h1>Telerik Licensing - Login Successful ✅</h1>\n    <p>You can close this window and return to the terminal.</p>\n</body>\n</html>\n')}async start(){let e=this.state.port;e||(e=await async function(e=3e4,t=5e4){for(let n=0;n<10;n++){const n=Math.floor(Math.random()*(t-e+1))+e;if(await pt(n))return n}throw new Error(`No available ports found in range ${e}-${t} after 10 attempts`)}(),this.state.port=e),await this.tryStartOnPort(e),this.state.isListening=!0,this.setupTimeout()}waitForCallback(){if(!this.state.isListening)throw new Error("Server is not listening - call start() first");return new Promise((e,t)=>{this.callbackPromise={resolve:e,reject:t}})}async stop(){if(this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.httpServer)return new Promise(e=>{this.httpServer.close(()=>{this.state.isListening=!1,e()})})}getCallbackUrl(){return`http://${this.state.host}:${this.state.port}${this.state.callbackPath}`}getPort(){return this.state.port}isListening(){return this.state.isListening}getRequestCount(){return this.state.requestsReceived}}function ft(e){return"127.0.0.1"===e||"::1"===e||"::ffff:127.0.0.1"===e}async function mt(e){let t,n="";try{t=new ht(e),await t.start();const o=t.getPort();n=t.getCallbackUrl(),le(`Local callback server started on port ${o}`)}catch(e){throw new G(`Failed to start local server: ${e.message}`,5,"Try specifying a different port with --port")}return{callbackUrl:n,callbackData:t.waitForCallback().finally(async()=>{try{le("Stopping local callback server..."),await t.stop(),le("Server stopped successfully")}catch(t){throw e=`Error stopping server: ${t.message}`,console.error(ae("ERROR",e,n)),new G(`Failed to stop server: ${t.message}`,5,"The server may still be running")}var e,n})}}var wt;!function(e){e.WAITING_FOR_AUTH="waiting",e.CODE_RECEIVED="code_received",e.AUTHENTICATED="authenticated"}(wt||(wt={}));class gt{constructor(e){!function(){if(!P.CLIENT_ID)throw new Error("OAuth CLIENT_ID not configured");if(!P.CLIENT_SECRET)throw new Error("OAuth CLIENT_SECRET not configured");if(!P.AUTHORIZATION_URL)throw new Error("OAuth AUTHORIZATION_URL not configured");if(!P.TOKEN_URL)throw new Error("OAuth TOKEN_URL not configured");try{new URL(P.AUTHORIZATION_URL),new URL(P.TOKEN_URL)}catch(e){throw new Error("Invalid OAuth URL configuration")}}(),this.redirectUrl=e,this.state=this.generateStateParameter(),this.authorizationUrl=this.generateAuthorizationUrl()}handleCallback(e){const{code:t,state:n,error:o,error_description:r}=e;if(o){throw new J(r||`OAuth error: ${o}`,"Please try authenticating again")}if(!t)throw new J("No authorization code received","The OAuth callback was incomplete");if(!n)throw new J("No state parameter received","The OAuth callback was incomplete");try{this.setAuthorizationCode(t,n),le(`Authorization code received: ${t.substring(0,10)}...`)}catch(o){throw new J(o.message,"Possible security issue - please try again")}}async getAccessToken(){if(this.accessToken)return le("Returning cached access token"),this.accessToken;if(!this.hasAuthorizationCode())throw new J("No authorization code available","Complete the OAuth flow first");return le("Access token requested, exchanging code for token..."),await this.exchangeCodeForToken(),this.accessToken}generateAuthorizationUrl(){const e=new URLSearchParams({client_id:P.CLIENT_ID,response_type:"code",redirect_uri:this.redirectUrl,state:this.state});return this.updateStatus(wt.WAITING_FOR_AUTH),`${P.AUTHORIZATION_URL}?${e.toString()}`}async exchangeCodeForToken(){if(!this.hasAuthorizationCode())throw new J("No authorization code available","Complete the OAuth flow first");const e=this.getAuthorizationCode();le("Exchanging authorization code for access token");try{const r={grant_type:"authorization_code",code:e,redirect_uri:this.redirectUrl,client_id:P.CLIENT_ID},s={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json",...(n=P.CLIENT_ID,o=P.CLIENT_SECRET,{Authorization:`Basic ${Buffer.from(`${n}:${o}`).toString("base64")}`})};le(`Making token request to ${P.TOKEN_URL}`);const i=await Ae(P.TOKEN_URL,{method:"POST",headers:s,body:(t=r,Object.keys(t).map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(t[e])}`).join("&"))});if(200!==i.status){if(i.status>=400&&i.status<500){let e="";try{const t=JSON.parse(i.body);e=t.error_description||t.error||"Unknown error"}catch{e=`HTTP ${i.status} ${i.statusText}`}throw new J(`Token exchange failed: ${e}`,"Please try authenticating again")}throw new Y(`Token service error: HTTP ${i.status}`,"The authentication service may be temporarily unavailable. Please try again later.")}{const e=JSON.parse(i.body);this.validateTokenResponse(e),this.setAccessToken(e.access_token),le(`Access token received, expires in ${e.expires_in||"unknown"} seconds`)}}catch(e){if(e instanceof J||e instanceof Y)throw e;throw new Y(`Failed to exchange authorization code: ${e.message}`,"Check your internet connection and try again")}var t,n,o}validateTokenResponse(e){if(!e.access_token)throw new J("Invalid token response: missing access_token");if(e.token_type&&"bearer"!==e.token_type.toLowerCase())throw new J(`Unsupported token type: ${e.token_type}`);3!==e.access_token.split(".").length&&ce("Access token does not appear to be a valid JWT")}generateStateParameter(){return y(16).toString("hex")}updateStatus(e){this.status=e}setAuthorizationCode(e,t){if(t!==this.state)throw new Error("Invalid state parameter - possible CSRF attack");this.authorizationCode=e,this.updateStatus(wt.CODE_RECEIVED)}setAccessToken(e){this.accessToken=e,this.updateStatus(wt.AUTHENTICATED)}hasAuthorizationCode(){return!(!this.authorizationCode||this.status!==wt.CODE_RECEIVED)}getAuthorizationCode(){return this.authorizationCode}}const yt={command:"refresh",describe:"Downloads a new license key file after authenticating to telerik.com via a web browser.\nBy default, the license file is saved in the user's home directory.",builder:function(e){return e.option("output",{type:"string",description:"Specify custom license file path"}).option("timeout",{type:"number",description:"Authentication timeout, seconds",default:B/1e3}).option("port",{type:"number",description:"Preferred localhost port (random if not specified)"}).option("browser",{type:"boolean",description:"Automatically open browser",default:!0})},handler:async function(e){const{output:t,timeout:n,port:o,noBrowser:r}=function(e){const t={output:e.output,noBrowser:!e.browser,timeout:e.timeout,port:e.port};if(t.output&&/[<>:"|?*]/.test(t.output))throw new Error(`Invalid characters in output filename: ${t.output}`);if(isNaN(t.timeout)||t.timeout<=0)throw new Error("--timeout must be a positive number");if(t.timeout>0&&(t.timeout*=1e3),void 0!==t.port&&(t.port<=0||t.port>65535))throw new Error("--port must be a valid port number (1-65535)");return t}(e);le("Starting OAuth authentication flow..."),le("Starting local callback server...");const s=await mt({preferredPort:o,host:x,timeout:n}),i=s.callbackUrl;le(`Callback URL: ${i}`);const a=new gt(i),c=a.authorizationUrl;if(le(`Authorization URL: ${c}`),r)ue("Browser opening disabled with --no-browser"),nt(c);else{await async function(e){ue("Opening browser for authentication...");const t=await tt({url:e});return t?ue("Please complete authentication in your browser"):ce(`Could not open browser automatically. Please open this URL manually:\n  ${e}`),t}(c)||le("Browser opening failed, showing manual instructions")}ue(`Waiting for authentication (timeout in ${n/1e3}s)...`);const u=await s.callbackData;le("OAuth callback received"),ue("Processing callback data..."),a.handleCallback(u);const l=await a.getAccessToken(),d=await Pe({accessToken:l,outputPath:t});ue(`License key downloaded successfully to ${d.filePath} (${d.fileSize} bytes)`)}};var Et;!function(e){e.Trial="trial",e.Subscription="subscription",e.Perpetual="perpetual"}(Et||(Et={}));const It={command:"info",describe:"Prints information about the current license.",handler:async function(){console.log("Looking up your Telerik License key file...");const e=se();if(!1===e.success)return void console.error(`License key file not found: ${e.message}`);let t;console.log(`License key file found: ${e.source}\n`);try{t=await N(e.value,O);const n=we(t.iat).toLocaleString();console.log(`  License key:\n     Audience: ${t.aud}\n     Issued At: ${n}\n     License Id: ${t.licenseId}\n     Used Id: ${t.userId}`)}catch(e){return void console.log(`Corrupted Telerik and Kendo UI License Key content\nDownload a new copy of the license key from ${M}`)}(function(e){const t=qe(e);if(0===t.length)return void console.log("  No license evidences found in the License Key.\n");console.log("     Products:");for(const e of t){if("usage"===e.type)continue;const t=j[e.code]||e.code;console.log(`       ${t}`),console.log(`       ${Ut(e)}\n`)}})(t),await async function(e){const t=H(),n=await We(t);if(0===n.length)return void console.log("No product references detected in package.json\n");const o=Xe(e,n);if(o.productLicenses.size>0){console.log("  Licensed products in current project:");for(const e of o.productLicenses.values()){const t=j[e.code]||e.code,n=z[e.type],r=o.productVersions.find(t=>(t.productCode||t.productCodes[0])===e.code)?.version||"N/A";console.log(`      ${Tt} ${t} version ${r} (${n})\n`)}}if(o.productErrors.size>0){console.log("  Products with missing or expired licenses in current project:");for(const e of o.productErrors.values())console.log(`    ${Ct} ${e.productName}\n`)}}(t)}},Tt="✓",Ct="✗";function Ut(e){const t=e.expiration?we(e.expiration).toLocaleDateString():"N/A",n=!!e.expiration&&Date.now()>=1e3*e.expiration,o=n?Ct:Tt;return e.type===Et.Trial?`${o} Trial license - ${n?"expired on":"expires on"} ${t}`:e.type===Et.Subscription?`${o} Subscription license - ${n?"expired on":"valid until"} ${t}`:e.type===Et.Perpetual?`${Tt} Perpetual license - valid for versions released before ${t}`:void 0}async function vt(e){return await N(e,O)}async function Lt(e){return await k(e,O)}export{lt as activateCommand,Lt as decodeLicenseEvidence,vt as decodeLicenseKey,dt as helpCommand,It as infoCommand,se as loadLicense,yt as refreshCommand};
